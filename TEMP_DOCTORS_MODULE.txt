

// ==================== DOCTORS MANAGEMENT ====================

// Load Doctors
async function loadDoctors() {
    const doctorsRef = ref(database, `doctors/${currentUser.uid}`);
    onValue(doctorsRef, (snapshot) => {
        doctorsData = [];
        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                doctorsData.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
        }
        filteredDoctors = [...doctorsData];
        renderDoctors();
    });
}

// Render Doctors with Pagination
function renderDoctors() {
    const tbody = document.getElementById('doctorsTableBody');
    if (!tbody) return;
    
    const totalPages = Math.ceil(filteredDoctors.length / itemsPerPage);

    if (filteredDoctors.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-user-md text-4xl mb-2 opacity-20"></i>
                    <p>No doctors added yet</p>
                </td>
            </tr>
        `;
        document.getElementById('doctorsPagination').innerHTML = '';
        return;
    }

    const startIndex = (currentDoctorsPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredDoctors.slice(startIndex, endIndex);

    tbody.innerHTML = pageData.map(doctor => {
        const defaultBadge = doctor.isDefault 
            ? '<span class="status-badge bg-green-100 text-green-800">âœ“ Default</span>' 
            : '<button onclick="setDefaultDoctor(\'' + doctor.id + '\')" class="text-blue-600 hover:underline text-xs">Set Default</button>';

        return `
            <tr class="border-b hover:bg-gray-50 transition">
                <td class="px-4 py-3 text-sm font-semibold text-purple-600">${doctor.name}</td>
                <td class="px-4 py-3 text-sm">${doctor.qualification}</td>
                <td class="px-4 py-3 text-sm">${doctor.specialization}</td>
                <td class="px-4 py-3 text-sm font-mono text-xs">${doctor.registrationNumber}</td>
                <td class="px-4 py-3 text-sm">${doctor.mobile}</td>
                <td class="px-4 py-3 text-sm">${defaultBadge}</td>
                <td class="px-4 py-3 text-sm">
                    <button onclick="editDoctor('${doctor.id}')" class="text-green-600 hover:underline mr-2" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteDoctor('${doctor.id}')" class="text-red-600 hover:underline" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    renderPagination('doctorsPagination', totalPages, currentDoctorsPage, (page) => {
        currentDoctorsPage = page;
        renderDoctors();
    });
}

// Search Doctors
window.searchDoctors = () => {
    const query = document.getElementById('doctorSearch').value.toLowerCase().trim();

    if (!query) {
        filteredDoctors = [...doctorsData];
    } else {
        filteredDoctors = doctorsData.filter(d =>
            d.name.toLowerCase().includes(query) ||
            d.specialization.toLowerCase().includes(query) ||
            d.qualification.toLowerCase().includes(query) ||
            d.registrationNumber.toLowerCase().includes(query)
        );
    }

    currentDoctorsPage = 1;
    renderDoctors();
};

// Open Add Doctor Modal
window.openAddDoctorModal = () => {
    showModal(`
        <h3 class="text-2xl font-bold mb-6"><i class="fas fa-user-md text-blue-600"></i> Add New Doctor</h3>
        
        <form onsubmit="addDoctor(event)" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2">Doctor Name *</label>
                    <input type="text" id="doctorName" required placeholder="Dr. John Doe"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Qualification *</label>
                    <input type="text" id="doctorQualification" required placeholder="MBBS, MD"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2">Specialization *</label>
                    <select id="doctorSpecialization" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Specialization</option>
                        <option value="General Medicine">General Medicine</option>
                        <option value="Pediatrics">Pediatrics</option>
                        <option value="Gynecology">Gynecology</option>
                        <option value="Orthopedics">Orthopedics</option>
                        <option value="Cardiology">Cardiology</option>
                        <option value="Dermatology">Dermatology</option>
                        <option value="ENT">ENT</option>
                        <option value="Ophthalmology">Ophthalmology</option>
                        <option value="Psychiatry">Psychiatry</option>
                        <option value="Dentistry">Dentistry</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Registration Number *</label>
                    <input type="text" id="doctorRegistration" required placeholder="MCI12345"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2">Mobile Number *</label>
                    <input type="tel" id="doctorMobile" required placeholder="9876543210" pattern="[0-9]{10}"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Email (Optional)</label>
                    <input type="email" id="doctorEmail" placeholder="doctor@example.com"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="doctorIsDefault" class="w-4 h-4">
                    <span class="text-sm">Set as default doctor</span>
                </label>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-4 rounded-lg hover:from-blue-700 hover:to-blue-800 font-semibold">
                    <i class="fas fa-save mr-2"></i> Save Doctor
                </button>
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 font-semibold">
                    <i class="fas fa-times mr-2"></i> Cancel
                </button>
            </div>
        </form>
    `);
};

// Add Doctor
window.addDoctor = async (e) => {
    e.preventDefault();

    const doctorData = {
        name: document.getElementById('doctorName').value.trim(),
        qualification: document.getElementById('doctorQualification').value.trim(),
        specialization: document.getElementById('doctorSpecialization').value,
        registrationNumber: document.getElementById('doctorRegistration').value.trim(),
        mobile: document.getElementById('doctorMobile').value.trim(),
        email: document.getElementById('doctorEmail').value.trim() || '',
        isDefault: document.getElementById('doctorIsDefault').checked,
        createdAt: new Date().toISOString()
    };

    // If setting as default, unset other defaults
    if (doctorData.isDefault) {
        const updates = {};
        doctorsData.forEach(doc => {
            if (doc.isDefault) {
                updates[`doctors/${currentUser.uid}/${doc.id}/isDefault`] = false;
            }
        });
        if (Object.keys(updates).length > 0) {
            await update(ref(database), updates);
        }
    }

    await push(ref(database, `doctors/${currentUser.uid}`), doctorData);
    closeModal();
    showNotification('Doctor added successfully!', 'success');
};

// Edit Doctor
window.editDoctor = (doctorId) => {
    const doctor = doctorsData.find(d => d.id === doctorId);
    if (!doctor) return;

    showModal(`
        <h3 class="text-2xl font-bold mb-6"><i class="fas fa-edit text-green-600"></i> Edit Doctor</h3>
        
        <form onsubmit="updateDoctor(event, '${doctorId}')" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2">Doctor Name *</label>
                    <input type="text" id="editDoctorName" required value="${doctor.name}"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Qualification *</label>
                    <input type="text" id="editDoctorQualification" required value="${doctor.qualification}"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2">Specialization *</label>
                    <select id="editDoctorSpecialization" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Specialization</option>
                        <option value="General Medicine" ${doctor.specialization === 'General Medicine' ? 'selected' : ''}>General Medicine</option>
                        <option value="Pediatrics" ${doctor.specialization === 'Pediatrics' ? 'selected' : ''}>Pediatrics</option>
                        <option value="Gynecology" ${doctor.specialization === 'Gynecology' ? 'selected' : ''}>Gynecology</option>
                        <option value="Orthopedics" ${doctor.specialization === 'Orthopedics' ? 'selected' : ''}>Orthopedics</option>
                        <option value="Cardiology" ${doctor.specialization === 'Cardiology' ? 'selected' : ''}>Cardiology</option>
                        <option value="Dermatology" ${doctor.specialization === 'Dermatology' ? 'selected' : ''}>Dermatology</option>
                        <option value="ENT" ${doctor.specialization === 'ENT' ? 'selected' : ''}>ENT</option>
                        <option value="Ophthalmology" ${doctor.specialization === 'Ophthalmology' ? 'selected' : ''}>Ophthalmology</option>
                        <option value="Psychiatry" ${doctor.specialization === 'Psychiatry' ? 'selected' : ''}>Psychiatry</option>
                        <option value="Dentistry" ${doctor.specialization === 'Dentistry' ? 'selected' : ''}>Dentistry</option>
                        <option value="Other" ${doctor.specialization === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Registration Number *</label>
                    <input type="text" id="editDoctorRegistration" required value="${doctor.registrationNumber}"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2">Mobile Number *</label>
                    <input type="tel" id="editDoctorMobile" required value="${doctor.mobile}" pattern="[0-9]{10}"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block font-semibold mb-2">Email (Optional)</label>
                    <input type="email" id="editDoctorEmail" value="${doctor.email || ''}"
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="editDoctorIsDefault" ${doctor.isDefault ? 'checked' : ''} class="w-4 h-4">
                    <span class="text-sm">Set as default doctor</span>
                </label>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white py-3 px-4 rounded-lg hover:from-green-700 hover:to-green-800 font-semibold">
                    <i class="fas fa-save mr-2"></i> Update Doctor
                </button>
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 font-semibold">
                    <i class="fas fa-times mr-2"></i> Cancel
                </button>
            </div>
        </form>
    `);
};

// Update Doctor
window.updateDoctor = async (e, doctorId) => {
    e.preventDefault();

    const updatedData = {
        name: document.getElementById('editDoctorName').value.trim(),
        qualification: document.getElementById('editDoctorQualification').value.trim(),
        specialization: document.getElementById('editDoctorSpecialization').value,
        registrationNumber: document.getElementById('editDoctorRegistration').value.trim(),
        mobile: document.getElementById('editDoctorMobile').value.trim(),
        email: document.getElementById('editDoctorEmail').value.trim() || '',
        isDefault: document.getElementById('editDoctorIsDefault').checked,
        updatedAt: new Date().toISOString()
    };

    // If setting as default, unset other defaults
    if (updatedData.isDefault) {
        const updates = {};
        doctorsData.forEach(doc => {
            if (doc.id !== doctorId && doc.isDefault) {
                updates[`doctors/${currentUser.uid}/${doc.id}/isDefault`] = false;
            }
        });
        if (Object.keys(updates).length > 0) {
            await update(ref(database), updates);
        }
    }

    await update(ref(database, `doctors/${currentUser.uid}/${doctorId}`), updatedData);
    closeModal();
    showNotification('Doctor updated successfully!', 'success');
};

// Delete Doctor
window.deleteDoctor = async (doctorId) => {
    if (!confirm('Are you sure you want to delete this doctor?')) return;
    
    await remove(ref(database, `doctors/${currentUser.uid}/${doctorId}`));
    showNotification('Doctor deleted successfully!', 'success');
};

// Set Default Doctor
window.setDefaultDoctor = async (doctorId) => {
    const updates = {};
    
    // Unset all defaults
    doctorsData.forEach(doc => {
        updates[`doctors/${currentUser.uid}/${doc.id}/isDefault`] = false;
    });
    
    // Set new default
    updates[`doctors/${currentUser.uid}/${doctorId}/isDefault`] = true;
    
    await update(ref(database), updates);
    showNotification('Default doctor updated!', 'success');
};
